<template>
  <div class="bg-white shadow-lg rounded-xl w-full">
    <div class="pt-6 px-8">
      <h3 class="text-heading-4 text-black font-heading-1">
        {{ title }}
      </h3>
    </div>
    <div
      class="pt-6 px-8 flex flex-wrap gap-6 lg:gap-0 justify-end lg:justify-between items-center"
    >
      <div class="relative w-full lg:w-[50%] z-0">
        <input
          type="text"
          name="search"
          class="py-3 px-5 bg-white border shadow-sm border-slate-300 placeholder-primary focus:outline-none focus:border-primary focus:ring-primary block w-full rounded-md sm:text-sm md:text-lg focus:ring-1"
          :placeholder="placeholder"
          v-model="search"
          @input="filterData"
        />
        <span class="absolute right-6 top-2 text-heading-4 text-primary">
          <i class="ri-search-line"></i>
        </span>
      </div>
      <div>
        <button
          v-if="dashboardType === 'daftarPerangkat'"
          class="bg-primary text-white px-4 py-3 rounded-lg transition duration-300 ease-in-out"
          @click="openConfirmationDevice"
        >
          Tambah Data
        </button>
        <button
          v-if="dashboardType === 'daftarPengguna'"
          class="bg-primary text-white px-4 py-3 rounded-lg transition duration-300 ease-in-out"
          @click="openConfirmation"
        >
          Tambah Data
        </button>
        <button
          v-if="dashboardType === 'daftarPenggunaDaerah'"
          class="bg-primary text-white px-4 py-3 rounded-lg transition duration-300 ease-in-out"
          @click="openConfirmationUserRegion"
        >
          Tambah Data
        </button>
        <button
          v-if="dashboardType === 'daftarDesa'"
          class="bg-primary text-white px-4 py-3 rounded-lg transition duration-300 ease-in-out"
          @click="openConfirmationRegion"
        >
          Tambah Data
        </button>
      </div>
    </div>
    <div class="mt-4">
      <DashboardTable
        :dashboardType="dashboardType"
        :tableData="filteredData"
        @user-changed="handleUserChanged"
        @delete-user="handleDeleteUser"
        @user-region-changed="handleUserRegionChanged"
        @delete-user-region="handleDeleteUserRegion"
        @device-changed="handleDeviceChanged"
        @delete-device="handleDeleteDevice"
        @region-changed="handleRegionChanged"
        @delete-region="handleDeleteRegion"
      />
    </div>
    <PopupEdit
      :showPopup="showConfirmation"
      @update:showPopup="showConfirmation = $event"
      :user="userData"
      @confirmed="createUser(userData)"
      title="Buat Akun Baru"
      :type="createUserData"
    />
    <PopupEdit
      :showPopup="showConfirmationUserRegion"
      @update:showPopup="showConfirmationUserRegion = $event"
      :user="userDataRegion"
      @confirmed="createUserRegion(userDataRegion)"
      title="Buat Akun Baru"
      :type="createUserDataRegion"
    />
    <PopupAddDevice
      :showPopup="showConfirmationDevice"
      @update:showPopup="showConfirmationDevice = $event"
      :device="deviceData"
      @confirmed="createDevice(deviceData)"
      title="Buat Perangkat Baru"
    />
    <PopupAddRegion
      :showPopup="showConfirmationRegion"
      @update:showPopup="showConfirmationRegion = $event"
      :region="regionData"
      @confirmed="createRegion(regionData)"
      title="Buat Desa Baru"
    />
  </div>
</template>

<script>
import DashboardTable from "~/components/table/DashboardTable.vue";
import { mapGetters } from "vuex";
import { mapMutations } from "vuex";

export default {
  name: "CardItemLaporan",
  components: {
    DashboardTable,
  },
  props: {
    title: {
      type: String,
      required: true,
    },
    placeholder: {
      type: String,
      required: true,
    },
    tableData: {
      type: Array || Object,
      required: true,
    },
    dashboardType: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      search: "", // Tambahkan data search sebagai data reactive
      showConfirmation: false,
      showConfirmationDevice: false,
      showConfirmationRegion: false,
      showConfirmationUserRegion: false,
      userData: {
        // id: "",
        nama: "",
        email: "",
        role: "USER",
        password: "",
        regionId: "",
      },
      userDataRegion: {
        // id: "",
        nama: "",
        email: "",
        role: "",
        password: "",
        // regionId: this.loggedInUser.regionId,
      },
      deviceData: {
        id_region: "",
        nama_perangkat: "",
        maksimum_air: "",
        harga: "",
      },
      regionData: {
        // id: "",
        nama: "",
      },
      createUserData: "create",
      createUserDataRegion: "createUserDaerah",
    };
  },
  watch: {
    // Pantau perubahan pada properti dashboardType
    dashboardType: {
      immediate: true,
      handler(newVal) {
        // Gunakan properti dashboardType sebagai searchByColumn
        this.searchByColumn = this.getSearchByColumn(newVal);
      },
    },
  },
  computed: {
    ...mapGetters(["loggedInUser"]),
    userDataRegionComputed() {
      return {
        ...this.userDataRegion,
        regionId: this.loggedInUser.regionId,
      };
    },
    localTableData() {
      return this.tableData;
    },
    // Buat computed property untuk mendapatkan data yang telah difilter berdasarkan search
    filteredData() {
      if (this.search.trim() === "") {
        // Jika search kosong, tampilkan semua data
        return this.localTableData;
      } else {
        // Jika search tidak kosong, filter data berdasarkan search
        return this.localTableData.filter((item) => {
          // Misalkan kita ingin mencari berdasarkan kolom "namaDaerah", sesuaikan dengan kolom yang diinginkan
          return item[this.searchByColumn]
            .toLowerCase()
            .includes(this.search.trim().toLowerCase());
        });
      }
    },
    ...mapMutations(["closeNotification"]),
  },
  methods: {
    ...mapMutations(["addNotification"]),
    // Fungsi ini akan dipanggil saat input search berubah
    filterData() {
      if (
        this.$refs.dashboardTable &&
        this.$refs.dashboardTable.$refs.pagination
      ) {
        this.$refs.dashboardTable.$refs.pagination.resetPage();
      }
    },
    // Fungsi untuk mendapatkan searchByColumn berdasarkan dashboardType
    getSearchByColumn(dashboardType) {
      switch (dashboardType) {
        case "adminUtama":
          return "namaDaerah";
        case "adminDaerah":
          return "nama";
        case "pengguna":
          return "nama";
        case "daftarPerangkat":
          return "nama_perangkat";
        default:
          return "nama"; // Ganti dengan nilai default yang sesuai ( ini untuk manajement pengguna)
      }
    },
    // Tangani perubahan data yang diberikan dari DashboardTable
    handleUserChanged(id, user) {
      console.log("user", user);
      // Perbarui data yang diberikan oleh DashboardTable dengan nilai yang baru
      this.tableData = this.tableData.map((item) => {
        if (item.id === id) {
          item.nama = user.nama;
          item.email = user.email;
          item.role = user.role;
          item.regionId = user.regionId;
          item.regionName = user.regionName;
        }
        return item;
      });

      console.log("setelah edit", this.tableData);
    },
    handleDeleteUser(id) {
      // Cari indeks data yang dihapus dalam tableData
      const deletedIndex = this.tableData.findIndex((item) => item.id === id);

      // Jika indeks data yang dihapus ditemukan, hapus data tersebut dari array tableData
      if (deletedIndex !== -1) {
        this.tableData.splice(deletedIndex, 1);

        // Perbarui kembali index untuk data-data yang ada setelah data yang dihapus
        // dengan mengurangi 1 pada index-nya
        for (let i = deletedIndex; i < this.tableData.length; i++) {
          this.tableData[i].index -= 1;
        }
      }
    },
    handleUserRegionChanged(id, userRegion) {
      console.log(id, userRegion);
      // Perbarui data yang diberikan oleh DashboardTable dengan nilai yang baru
      this.tableData = this.tableData.map((item) => {
        if (item.id === id) {
          item.nama = userRegion.nama;
          item.email = userRegion.email;
          item.role = userRegion.role;
        }
        return item;
      });
    },
    handleDeleteUserRegion(id) {
      // Cari indeks data yang dihapus dalam tableData
      const deletedIndex = this.tableData.findIndex((item) => item.id === id);

      // Jika indeks data yang dihapus ditemukan, hapus data tersebut dari array tableData
      if (deletedIndex !== -1) {
        this.tableData.splice(deletedIndex, 1);

        // Perbarui kembali index untuk data-data yang ada setelah data yang dihapus
        // dengan mengurangi 1 pada index-nya
        for (let i = deletedIndex; i < this.tableData.length; i++) {
          this.tableData[i].index -= 1;
        }
      }
    },
    resetFormData(data, type) {
      data.nama = "";
      data.email = "";
      data.role = "";
      if (type) {
        data.role = "USER";
      }
      data.password = "";
      data.id_region = "";
      data.nama_perangkat = "";
      data.maksimum_air = "";
      data.harga = "";
      data.regionId = "";
      data.index = "";
      data.id = "";
    },
    async createUser(userData) {
      this.$store.commit("loading/setLoading", true);
      console.log(userData);
      try {
        // Kirim permintaan ke server untuk membuat pengguna baru
        const response = await this.$axios.post("/signup", {
          fullname: userData.nama,
          email: userData.email,
          role: userData.role,
          password: userData.password,
          regionId: userData.regionId,
        });

        console.log(response);

        // Jika permintaan berhasil dan server memberikan respons status 201 (Created)
        if (response.status === 201) {
          // Dapatkan ID pengguna baru dari respons server
          const newUserId = response.data.data.id;
          const newRegionName = response.data.data.regionName;

          // Dapatkan indeks terakhir dalam tabel data saat ini

          const newUser = {
            id: newUserId,
            index: 1,
            nama: userData.nama,
            email: userData.email,
            role: userData.role,
            regionId: userData.regionId,
            regionName: newRegionName,
          };

          // Tambahkan pengguna baru ke dalam tabel data
          this.tableData.push(newUser);

          for (let i = 1; i < this.tableData.length; i++) {
            this.tableData[i].index = i + 1;
          }

          // Kosongkan nilai input setelah berhasil menambahkan data perangkat
          this.resetFormData(userData, true);

          // Beritahu pengguna bahwa pengguna baru telah dibuat dengan sukses (opsional)
          this.addNotification({
            message: "Pengguna baru berhasil dibuat!",
            status: "success",
          });
          this.showConfirmation = false;
        } else {
          // Jika server memberikan respons selain 201, maka tampilkan pesan kesalahan (opsional)
          this.addNotification({
            message: "Gagal membuat pengguna baru. Silakan coba lagi.",
            status: "error",
          });
        }
        this.$store.commit("loading/setLoading", false);
      } catch (error) {
        this.$store.commit("loading/setLoading", false);
        // Jika terjadi kesalahan pada permintaan atau server memberikan respons error, tampilkan pesan kesalahan (opsional)
        this.addNotification({
          message: error.response.data.message,
          status: "error",
        });
      }
    },
    openConfirmation() {
      this.showConfirmation = true;
    },

    // Fungsi untuk membuat pengguna baru daerah
    async createUserRegion(userDataRegion) {
      this.$store.commit("loading/setLoading", true);
      try {
        const regionId = this.userDataRegionComputed.regionId;
        // Kirim permintaan ke server untuk membuat pengguna baru
        const response = await this.$axios.post("/signup", {
          fullname: userDataRegion.nama,
          email: userDataRegion.email,
          role: userDataRegion.role,
          password: userDataRegion.password,
          regionId: regionId,
        });

        console.log(response);

        // Jika permintaan berhasil dan server memberikan respons status 201 (Created)
        if (response.status === 201) {
          // Dapatkan ID pengguna baru dari respons server
          const newUserId = response.data.data.id;
          console.log(newUserId);

          const newUser = {
            id: newUserId,
            index: 1,
            nama: userDataRegion.nama,
            email: userDataRegion.email,
            role: userDataRegion.role,
            regionId: regionId,
          };

          // Tambahkan pengguna baru ke dalam tabel data
          this.tableData.unshift(newUser);

          for (let i = 1; i < this.tableData.length; i++) {
            this.tableData[i].index = i + 1;
          }

          this.resetFormData(userDataRegion);

          this.addNotification({
            message: "Pengguna baru berhasil dibuat!",
            status: "success",
          });
          this.showConfirmationUserRegion = false;
        } else {
          this.addNotification({
            message: "Gagal membuat pengguna baru. Silakan coba lagi.",
            status: "error",
          });
        }
        this.$store.commit("loading/setLoading", false);
      } catch (error) {
        this.$store.commit("loading/setLoading", false);
        this.addNotification({
          message: error.response.data.message,
          status: "error",
        });
      }
    },
    openConfirmationUserRegion() {
      this.showConfirmationUserRegion = true;
    },

    // device
    openConfirmationDevice() {
      this.showConfirmationDevice = true;
    },

    handleDeviceChanged(id, device) {
      console.log(id, device);
      this.tableData = this.tableData.map((item) => {
        if (item.id === id) {
          item.id_region = device.id_region;
          item.nama_perangkat = device.nama_perangkat;
          item.maksimum_air = device.maksimum_air;
          item.harga = device.harga;
        }
        return item;
      });
    },

    handleDeleteDevice(id) {
      const deletedIndex = this.tableData.findIndex((item) => item.id === id);

      if (deletedIndex !== -1) {
        this.tableData.splice(deletedIndex, 1);

        for (let i = deletedIndex; i < this.tableData.length; i++) {
          this.tableData[i].index -= 1;
        }
      }
    },

    async createDevice(deviceData) {
      this.$store.commit("loading/setLoading", true);
      console.log(typeof deviceData.harga);
      try {
        const response = await this.$axios.post("/devices", {
          regionId: deviceData.id_region,
          name: deviceData.nama_perangkat,
          max: parseInt(deviceData.maksimum_air),
          price: parseInt(deviceData.harga),
        });
        if (response.status === 201) {
          const device = {
            id: response.data.data.deviceId,
            index: 1,
            id_region: deviceData.id_region,
            nama_perangkat: deviceData.nama_perangkat,
            maksimum_air: parseInt(deviceData.maksimum_air),
            harga: parseInt(deviceData.harga),
            regionName: deviceData.nama_perangkat,
          };

          console.log("response devices", device);

          this.tableData.push(device);

          for (let i = 1; i < this.tableData.length; i++) {
            this.tableData[i].index = i + 1;
          }
          t;

          this.addNotification({
            message: "Perangkat baru berhasil dibuat!",
            status: "success",
          });
        } else {
          this.addNotification({
            message: "Gagal membuat perangkat baru. Silahkan coba lagi",
            status: "error",
          });
        }

        this.resetFormData(deviceData);
        this.$store.commit("loading/setLoading", false);
        this.showConfirmationDevice = false;
      } catch (error) {
        this.$store.commit("loading/setLoading", false);
        this.addNotification({
          message: error.response.data.message,
          status: "error",
        });
      }
    },

    // region
    async createRegion(regionData) {
      this.$store.commit("loading/setLoading", true);
      try {
        const response = await this.$axios.post("/regions", {
          name: regionData.nama,
        });

        console.log("respon", response);
        if (response.status === 201) {
          const newRegion = {
            index: 1,
            id: response.data.data.regionId,
            nama: regionData.nama,
          };

          console.log("newRegion", newRegion);

          this.tableData.unshift(newRegion);

          for (let i = 1; i < this.tableData.length; i++) {
            this.tableData[i].index = i + 1;
          }

          this.addNotification({
            message: "Desa baru berhasil dibuat!",
            status: "success",
          });

          regionData.nama = "";
          this.showConfirmationRegion = false;
        } else {
          this.addNotification({
            message: "Gagal membuat desa baru. Silakan coba lagi.",
            status: "error",
          });
        }
        this.$store.commit("loading/setLoading", false);
      } catch (error) {
        this.$store.commit("loading/setLoading", false);

        this.addNotification({
          message: error.response.data.message,
          status: "error",
        });
      }
    },
    openConfirmationRegion() {
      this.showConfirmationRegion = true;
    },

    handleRegionChanged(id, region) {
      console.log(id, region);
      this.tableData = this.tableData.map((item) => {
        if (item.id === id) {
          item.nama = region.nama;
        }
        return item;
      });
    },

    handleDeleteRegion(id) {
      const deletedIndex = this.tableData.findIndex((item) => item.id === id);

      if (deletedIndex !== -1) {
        this.tableData.splice(deletedIndex, 1);

        for (let i = deletedIndex; i < this.tableData.length; i++) {
          this.tableData[i].index -= 1;
        }
      }
    },
  },
};
</script>

<style></style>
